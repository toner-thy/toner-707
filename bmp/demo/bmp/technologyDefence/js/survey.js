define(function(require){"use strict";var e=require("jquery");var t=require("underscore");var i=require("lib/functions");var r=require("lib/survey");var n=r.Survey;var s=r.Part;var a=e(document);var o=e("html").hasClass("mobile");function c(e,i){this.options=t.defaults(i||{},{mobile:false,auto_index:false,enable_trigger:!t.isEmpty(e.triggers().exprs),enable_buttons:true,enable_progress_bar:!!e.pages().length,enable_captcha:false,prev_btn:false});this.response={};this.page_history=[e.firstPage()];this.page_response={};this.triggered_finish=[];this.survey=e;this.initEvents();this.toggleCaptcha();this.updateProgressBar();this.toggleButtons();var r=e.$survey;r.find(".survey-content").fadeIn("fast");r.find(".loading").hide();t.delay(t.bind(this._ping,this),3e5);if(this.options["enable_trigger"]){t.defer(function(){e.triggers().sanitize()})}}c.prototype.initEvents=function(){var r=this;var n=this.survey;var s=n.$survey;s.on("click",".select input:radio, .select input:checkbox, .matrix input, .sort input:checkbox",c);s.on("change",".part select",c);s.on("click",".sort .control button",c);s.on("keyup change",".part input:text, .part textarea, .text input",h);s.on("click",".buttons .prev",t.bind(this.goPrevPage,this));s.on("click",".buttons .next",t.bind(this.goNextPage,this));s.on("click",".buttons .submit",t.bind(this.submit,this));s.on("click",".captcha img, .captcha a.change",t.bind(this.changeCaptcha,this,true));s.on("keypress",".captcha input:text",function(e){if(e.which===13)r.checkCaptcha()});s.on("Pages.Changed",function(){var e=t.bind(r.updateProgressBar,r);i.delay_till_last("update progress bar",e,150)});var a=o?[]:s.find("input[data-widget=date]");if(a.length)requirejs(["jqueryui"],function(){var t=__("datepicker");for(var i=0,r;r=a[i++];){var n=e(r);n.datepicker({dateFormat:"yy-mm-dd",yearRange:"c-100:c+10",showAnim:"fadeIn",showButtonPanel:true,changeYear:true,changeMonth:true,dayNamesMin:t["dayNamesMin"],monthNamesShort:t["monthNamesShort"],currentText:t["currentText"],closeText:t["closeText"],nextText:t["nextText"],prevText:t["prevText"],onSelect:function(){n.trigger("_change")}}).keydown(function(){this.value="";return false})}});t.each(n.parts(),function(e){if(e.is("sort"))e.initEvents()});function c(t){var s=e(this).parents(".part").data("sn");i.delay_till_last("check_on_choose_"+s,function(){var i=n.part(s);if(i.is("select"))i.onChoose(e(t.target));var a=i.getResponse();if(i.is("select"))i.toggleSpecifyBox(a);r.checkPartResponse(i,a);r.updateTriggers(i)},50)}function h(){var t=e(this).parents(".part").data("sn");i.delay_till_last("check_on_input_"+t,function(){var e=n.part(t);r.checkPartResponse(e)},500)}};c.prototype.submit=function(){if(this._saving)return true;this._saving=true;var t=this.survey.$survey;var i=t.find(".buttons button");var r=t.find(".captcha input:text").val();r=e.trim(r);i.prop("disabled",true);var n=this;this._submit(r).always(function(){n._saving=false;i.prop("disabled",false)}).fail(function(e){if(!e)return false;if(e===400){h(__("bad survey response"))}else{h("Error: #"+e)}}).done(function(e){window.location.replace(e)})};c.prototype.checkPageResponse=function(){var t=this._checkPageResponse();t.fail(function(t){var r=o?50:200;i.scroll_to(e("html, body"),t.el(),{duration:200},r)});return t};c.prototype.checkPartResponse=function(e,i){var r=e.el();if(t.isUndefined(i))i=e.getResponse();try{s(e,i)}catch(n){!r.hasClass("error")&&r.addClass("error");return false}r.find(".error").add(r).removeClass("error");return true;function s(e,t){if(!e.isQuestion()||e.el().is(":hidden"))return true;if(typeof t=="undefined")t=e.getResponse();e.checkResponse(t)}};c.prototype.updateIndexNumber=function(e){if(!this.options["auto_index"]||!this.options["enable_trigger"])return true;var r=this;i.delay_till_last("updatePartIndexNumber@"+e.id(),function(){var i=t.reduce(r.page_response,function(e,i){return e+t.size(i)},0);e.updatePartIndexNumber(i+1)},200)};c.prototype.getCurrentPage=function(){return t.last(this.page_history)};c.prototype.getPrevPage=function(){if(!this.options["prev_btn"])return false;var e=this.page_history;var t=e.length;return t<2?false:e[t-2]};c.prototype.getNextPage=function(e){if(this.triggered_finish.length)return false;e=e||this.getCurrentPage();var t=e.next();if(!t)return false;if(!this.survey.triggers().getCondition(t))return t;return this._isTriggered(t)?t:this.getNextPage(t)};c.prototype.goPrevPage=function(){var e=this.getPrevPage();if(!e)return;var i=this.survey;var r=this.getCurrentPage();this.page_history.pop();this.showPage(e);delete this.page_response[e.id()];if(this.page_history.length===1)i.$survey.find(".survey-intro").show();if(this.options["enable_trigger"]){var n=i.triggers();t.each(r.parts(),function(e){if(!e.isQuestion()||e.el().css("display")=="none")return false;e.reset();this.updateTriggers(e,false)},this)}};c.prototype.goNextPage=function(){var e=this.getNextPage();if(!e)return;var t=this.getCurrentPage();var i=this.checkPageResponse(t);var r=this;i.done(function(i){r.page_response[t.id()]=i;r.page_history.push(e);r.survey.$survey.find(".survey-intro").hide();r.showPage(e,true).then(function(){r.updateIndexNumber(e)})});return i};c.prototype.showPage=function(t,r){var n=new e.Deferred;var s=t.el();var a=this.survey.$survey;if(s.is(":visible"))return n.resolve().promise();a.find(".survey-body .page:visible").hide();s.fadeIn("fast",function(){r&&i.scroll_to(e("html, body"),s,{duration:200})});this.toggleButtons();this.toggleCaptcha();this.updateProgressBar();return n.resolve().promise()};c.prototype.updateTriggers=function(e,i){if(!this.options["enable_trigger"])return true;var r=this.survey.triggers().getExprs(e);if(!r)return;var n;if(typeof i==="undefined"){i=null;n=e.getResponse()}var s={};t.each(r,function(t,r){var o=i===null?a(e,n,r):i;if(t.active===o)return true;t.active=o;s[r]=t});t.each(s,function(t,i){this.executeTrigger(t,e,i)},this);function a(e,i,r){if(e.is("select")){return t.contains(i.choice,r)}else if(e.is("matrix")){r=r.split(",");var n=r[0];var s=r[1];return i[n]&&t.contains(i[n],s)}return false}};c.prototype.executeTrigger=function(e,r,n){var s=this;var a=this.survey;var o=a.$survey;var c=e.active;e.parts&&t.each(e.parts,function(e){var t=a.part(e);if(t.is("page"))return o.trigger("Pages.Changed");var i=t.parent();if(c){t.el().fadeIn("fast",function(){s.updateIndexNumber(i)})}else{this.hidePartByTrigger(t);s.updateIndexNumber(i)}},this);e.options&&t.each(e.options,function(e,t){var i=a.part(t);if(c){i.showOptions(e)}else{this.hideOptionsByTrigger(i,e)}this.updateIndexNumber(i.parent())},this);if(e.finish){var h=this.triggered_finish;var u=r.id()+":"+n;if(c){h.push(u);h=t.uniq(h)}else{h=t.without(h,u)}o.trigger("Pages.Changed");this.triggered_finish=h}i.delay_till_last("triggers.executed",t.bind(function(){this.toggleCaptcha();this.toggleButtons()},this),50)};c.prototype.hidePartByTrigger=function(e){if(this._isTriggered(e))return;var t=e.el();t.hide();if(e.isQuestion()){var r=this;i.delay_till_last("hide.part.by.trigger."+e.id(),function(){e.reset();r.updateTriggers(e,false)},100)}};c.prototype.hideOptionsByTrigger=function(e,r){r=t.reject(r,t.bind(this._isTriggered,this));if(!r.length)return false;e.hideOptions(r);var n=this;i.delay_till_last("hide.part.by.trigger."+e.id(),function(){n.updateTriggers(e)},100)};c.prototype.updateProgressBar=function(){if(!this.options["enable_progress_bar"])return true;var e=this.survey;var t=e.$survey;var i=t.find(".survey-footer .progress_bar");if(!i.length)return false;if(this.getCurrentPage().id()===e.firstPage().id()&&!this.getNextPage())return i.hide();var r=e.pages().length;var n=this.getCurrentPage();var s=n.get("rank")/r*100>>0;i.show().css("width",s+"%");t.find(".pages_bar").show()};c.prototype.toggleButtons=function(){if(!this.options["enable_buttons"])return true;var e=this.survey.$survey.find(".buttons");var t=e.find(".prev");var i=e.find(".next");var r=e.find(".submit");e.show();if(!this.options["prev_btn"]){t.hide()}else if(this.getPrevPage()){t.show()}else{t.hide()}if(this.getNextPage()){i.show();r.hide()}else{i.hide();r.show()}};c.prototype.toggleCaptcha=function(){if(!this.options["enable_captcha"])return false;if(this.getNextPage()){this.hideCaptcha()}else{this.showCaptcha()}};c.prototype.showCaptcha=function(){var e=this.survey.$survey.find(".captcha");if(e.is(":visible"))return true;e.show();this.changeCaptcha()};c.prototype.hideCaptcha=function(){var e=this.survey.$survey.find(".captcha");e.hide()};c.prototype.changeCaptcha=function(t){var i=this.survey.$survey;var r=i.find(".captcha input:text");i.find(".captcha img").attr("src","/captcha?t="+e.now());i.find(".captcha span").hide().empty();r.val("");if(t)r.focus()};c.prototype.checkCaptcha=function(){var t;var i=this.survey.$survey;var r=i.find(".captcha input:text");var n=i.find(".captcha span");var s=e.trim(r.val());n.show();n.attr("class","check").text(__("checking"));t=this._checkCaptcha(s);t.done(function(){n.attr("class","success").text(__("correct"));r.blur()}).fail(function(e,t){var i=t=="timeout"?__("ajax_timeout"):__("incorrect");n.attr("class","failed").text(i);r.focus()});return t};c.prototype._submit=function(r){var n=new e.Deferred;var s=this;this.checkPageResponse().then(function(e){t.each(s.page_response,function(i){t.extend(e,i)});s.checkCaptcha().then(a(e),o)},o);return n.promise();function a(t){t=i.clear_empty_object(t);var a={};a["captcha"]=r;a["response"]=t;e.ajax({url:window.location.href,type:"POST",data:JSON.stringify(a),complete:function(e){var t=e.status;if(t===201||t===401){var i=e.responseText;n.resolve(i)}else if(t===409){h(__("deny by response filter"));n.reject()}else if(t===412){s.options["enable_captcha"]=true;s.showCaptcha();n.reject()}else{n.reject(t)}}})}function o(){n.reject()}};c.prototype._checkPageResponse=function(i){var r=new e.Deferred;i=i||this.getCurrentPage();window.setTimeout(t.bind(function(){var e={};t.each(i.parts(),function(t){if(r.state()!="pending")return false;if(!t.isQuestion()||t.el().is(":hidden"))return false;var i=t.getResponse();if(!this.checkPartResponse(t,i)){r.reject(t)}else{e[t.id()]=i}},this);r.resolve(e)},this),0);return r.promise()};c.prototype._checkCaptcha=function(t){var i=new e.Deferred;if(!this.options["enable_captcha"]){i.resolve()}else if(t===""){i.reject(0)}else{e.ajax({url:"/captcha",type:"POST",data:{captcha:t},success:function(e,t,r){i.resolve(r.status)},error:function(e,t){i.reject(e.status,t)}})}return i.promise()};c.prototype._isTriggered=function(e){var i=this.survey.triggers();var r=i.getCondition(e);if(!r)return false;return!!t.find(r,function(e,r){return!!t.find(e,function(e){return i.getExprs(r,e).active})})};c.prototype._ping=function(){var i=window.location.href;i+=i.indexOf("?")===-1?"?ping":"&ping";e.get(i);t.delay(t.bind(this._ping,this),3e5)};t.extend(s._extends._question,{getResponse:function(){throw new Error("method not implemented")},reset:function(){throw new Error("method not implemented")},_getAssocCount:function(){if(!t.has(this,"_assoc_count"))this._assoc_count=t.size(this.get("__associated_options__"));return this._assoc_count}});t.extend(s._extends._options,{showOptions:function(e){throw new Error("method not implemented")},hideOptions:function(e){throw new Error("method not implemented")}});t.extend(s._extends.text,{getResponse:function(){var t=this.el().find("input, textarea");return e.trim(t.val())},checkResponse:function(e){var t=this.get("least");var i=this.get("most");var r=this.get("validator");var n=e.length;if(r=="date")t=i=0;if(this.get("required")&&e==="")throw new Error("required");if(e==="")return true;if(t&&n&&n<t)throw new Error("least input "+t);if(i&&n&&n>i)throw new Error("most input "+i);if(r=="number"&&e&&!/^\d+(\.\d+)?$/.test(e))throw new Error("on allow number");if(r=="email"&&e&&!/^[a-z0-9_\.\-]+@[a-z0-9_\.\-]+\.([a-z]+){2,4}$/i.test(e))throw new Error("invalid email")},reset:function(){this.el().find("input, textarea").val("")}});t.extend(s._extends.select,{getResponse:function(){var i=this.el();var r={choice:[],specify:{}};if(i.is(":hidden"))return r;var n=i.find("select");if(n.length){var s=n.val();s&&r.choice.push(s)}else{t.each(i.find("input:checked"),function(t){r["choice"].push(e(t).val())})}t.each(i.find("input:text"),function(i){var n=e(i);var s=n.attr("name");var a=e.trim(n.val());if(a!==""&&t.contains(r.choice,s))r["specify"][s]=a});return r},checkResponse:function(i){var r=i["choice"].length;var n=this.get("most")>>0;var s=this.get("least")>>0;if(this.get("required")&&!r)throw new Error("required");if(this.isMultipleChoice()){if(n&&r&&r>n)throw new Error("most choice "+n);if(s&&r&&r<s)throw new Error("least choice "+s)}var a=this.el();a.find(".error").removeClass("error");var o=t.some(this.get("options"),function(e){var r=this.getOptionId(e);if(!e["specify"]||!e["specify_required"]||!t.contains(i["choice"],r))return false;return!t.has(i["specify"],r)},this);if(o){t.each(a.find("input:text"),function(t){var i=e(t);var r=i.data("required")>>0;if(!r||i.is(":hidden"))return;if(e.trim(i.val())==="")i.addClass("error")});throw new Error("need option specify")}},reset:function(){var e=this.el();e.find("select").val("");e.find("input:checked").prop("checked",false);e.find("input:text").hide().val("");e.find(".error").removeClass("error")},toggleSpecifyBox:function(i){var r=this.el();i=i||this.getResponse();var n={};t.each(i.choice,function(e){n[e]=1});t.each(r.find("input:text"),function(t){var i=e(t);var r=i.attr("name");if(n[r]){i.show().focus()}else{i.hide().val("")}},this)},onChoose:function(i){if(!i.is(":checked:checkbox"))return;var r=this._getExclusiveOptions();if(!r)return;var n=t.has(r,i.val());var s=this.el().find("input:checked").not(i);t.each(s,function(i){var s=e(i);if(n){s.prop("checked",false)}else{t.has(r,s.val())&&s.prop("checked",false)}})},showOptions:function(e){var i=this.get("__associated_options__");var r=this.el();r.is(":hidden")&&r.fadeIn("fast");t.each(e,function(e){r.find('.option[data-id="'+e+'"]').fadeIn("fast");i[e]=true})},hideOptions:function(e){var i=this.get("__associated_options__");var r=this.el();t.each(e,function(e){var t=r.find('.option[data-id="'+e+'"]');t.hide();t.find("input:checked").prop("checked",false);t.find("input:text").hide().val("");i[e]=false});var n=!t.some(i,function(e,t){return e});if(n&&this._getAssocCount()===this.get("options").length)r.hide()},_getExclusiveOptions:function(){if(t.has(this,"_exclusive_options"))return this._exclusive_options;var e={};t.each(this.get("options"),function(t){if(t["exclusive"])e[this.getOptionId(t)]=true},this);if(t.isEmpty(e))e=false;return this._exclusive_options=e}});t.extend(s._extends.matrix,{getResponse:function(){var i=this.el();var r={};if(i.is(":hidden"))return r;var n=i.find("input:checked, select");t.each(n,function(t){var i=e(t);var n=i.val();if(!n)return false;var s=i.attr("name");if(!r[s])r[s]=[];r[s].push(n)});return r},checkResponse:function(e){if(!this.get("required"))return true;if(t.isEmpty(e))throw new Error("required");var i=this.el().find(".options .row:visible").length;var r=t.size(e);if(r&&r!==i)throw new Error("required")},reset:function(){var e=this.el();e.find("select").val("");e.find("input:checked").prop("checked",false)},showOptions:function(e){var i=this.get("__associated_options__");var r=this.el();r.is(":hidden")&&r.fadeIn("fast");t.each(e,function(e){r.find('.row[data-id="'+e+'"]').fadeIn("fast");i[e]=true})},hideOptions:function(e){var i=this.get("__associated_options__");var r=this.el();t.each(e,function(e){var t=r.find('.row[data-id="'+e+'"]');t.hide();t.find("input:checked").prop("checked",false);if(o)t.find("select").val("");i[e]=false});var n=!t.some(i,function(e,t){return e});if(n&&this._getAssocCount()===this.getRowOptions().length)r.hide()}});t.extend(s._extends.sort,{getResponse:function(){var i=this.el();var r=[];if(i.is(":hidden"))return r;t.each(i.find(".options select"),function(t){var i=e(t).val();if(i)r.push(i)});return r},reset:function(){var i=this.el();i.find("select").val("");t.each(i.find('select[name="hide_options"] option'),function(t){var r=e(t).val();i.find('.options select option[value="'+r+'"]').remove()})},checkResponse:function(e){var t=e.length;var i=this.get("least")>>0;var r=this.get("most")>>0;if(!t){if(this.get("required"))throw new Error("required");return true}if(i||r){if(i&&t<i){throw new Error("least choice "+i)}else if(r&&t>r){throw new Error("most choice "+r)}}else{var n=this.el().find(".options select:first option").length-1;if(t!==n)throw new Error("required")}},initEvents:function(){var i=this.el();i.on("change","select",function(){var r=e(this);var n=r.val();if(!n)return false;var s=i.find("select").not(r);t.each(s,function(t){var i=e(t);if(i.val()==n)i.val("")})})},showOptions:function(i){var r=this.el();r.is(":hidden")&&r.fadeIn("fast");t.each(i,function(i){var n=r.find('select[name="hide_options"] option[value="'+i+'"]');t.each(r.find(".options select"),function(t){n.clone().appendTo(e(t))})})},hideOptions:function(i){var r=this.el();t.each(i,function(e){r.find('.options select option[value="'+e+'"]').remove()});var n=r.find(".options select option");var s=t.find(n,function(t){return!!e(t).val()});if(!s)r.hide()}});function h(e){if(o){requirejs(["bootstrap3"],function(t){var i=t("#alert");i.find(".modal-body").text(e);i.modal("show")})}else{window.alert(e)}}return function u(t){var i=new n(e("#survey"));return new c(i,t)}});