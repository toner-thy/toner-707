define(function(require,exports){"use strict";var t=require("jquery");var e=require("underscore");var i=require("uuid");var r=require("lib/functions");var n={};var s=r.clear_empty_object;function o(t){this.props=t;if(this.isQuestion())e.extend(this,o._extends._question);if(this.has("options"))e.extend(this,o._extends._options);var i=o._extends[this.type()];if(i)e.extend(this,i)}o.prototype.set=function(t,i){var r=this.props;var n={};if(typeof t=="string"){n[t]=i}else{n=t}e.extend(this.props,n);if(this.survey)this.survey.setDirty(true);return this};o.prototype.get=function(t){var i=this.props;if(e.isUndefined(t))return i;return e.has(i,t)?i[t]:null};o.prototype.has=function(t){return e.has(this.props,t)};o.prototype.remove=function(){var t=this.$el;var e=this.survey;e.triggers().removeExprByPart(this);e.removePart(this);delete this.$el;delete this.props;delete this.survey;if(t&&t.length)t.remove();return true};o.prototype.id=function(){return this.props["__sn__"]};o.prototype.type=function(){return this.props["__type__"]};o.prototype.iconClass=function(){var t=this.type();var e="i_"+t;if(t=="select"){if(this.get("score")){e="i_rating"}else if(this.get("type")=="checkbox"){e="i_mselect"}}else if(t=="matrix"&&this.get("score")){e="i_matrix_rating"}return e};o.prototype.is=function(t){return t==this.type()};o.prototype.isQuestion=function(){return this.has("required")};o.prototype.el=function(t){if(t)return this.$el=t;if(this.$el)return this.$el;var e=this.survey;if(!e)return false;var i=e.$survey;var r=this.is("page")?"div.page":"div.part";r+='[data-sn="'+this.id()+'"]';var n=i.find(r);if(!n.length)return false;return this.$el=n};o.prototype.prev=function(t){return this._find("prev",t)};o.prototype.next=function(t){return this._find("next",t)};o.prototype.parent=function(){if(this.is("page"))return this.survey;return this.survey.findPartBy(this.el().parents("div.page"))};o.prototype.size=function(){return 0};o.prototype._find=function(t,e){var i;var r=this.el();var n=this.is("page")?"div.page":"div.part";if(t=="prev"){i=e?r.prevAll(n).filter(e):r.prev(n)}else{i=e?r.nextAll(n).filter(e):r.next(n)}return this.survey.findPartBy(i)};o._defaults={text:function(){return{type:"input",required:1,intro:""}},select:function(){return{required:1,type:"radio",options:[{__sn__:i()},{__sn__:i()},{__sn__:i()}],intro:""}},matrix:function(){return{required:1,type:"radio",options:[{__sn__:i(),dir:"row"},{__sn__:i(),dir:"row"},{__sn__:i(),dir:"row"},{__sn__:i()},{__sn__:i()},{__sn__:i()},{__sn__:i()},{__sn__:i()}],intro:""}},sort:function(){return{required:1,options:[{__sn__:i()},{__sn__:i()},{__sn__:i()},{__sn__:i()},{__sn__:i()}],intro:""}},separator:function(){return{intro:""}}};o._extends={_question:{getSubject:function(){return this.get("subject")||__("untitled question")},getLabel:function(){return this.getSubject()}},_options:{getOption:function(t){return e.find(this.get("options"),function(e){return e["__sn__"]==t})},getOptionId:function(t){return t["__sn__"]},getOptionLabel:function(t){return t["label"]||__("option")}},text:{size:function(){return 1}},select:{size:function(){return 1},isMultipleChoice:function(){return this.get("type")=="checkbox"}},matrix:{size:function(){return this.getRowOptions().length},getOptionLabel:function(t){return t["dir"]=="row"?t["label"]||__("question"):t["label"]||__("option")},getRowOptions:function(){return e.filter(this.get("options"),function(t){return t["dir"]=="row"})},getColOptions:function(){return e.filter(this.get("options"),function(t){return t["dir"]!="row"})}},sort:{size:function(){return 1}},page:{parts:function(){var i=this.survey.findPartBy;var r=this.el().find("div.part[data-sn]");return e.map(r,function(e){return i(t(e))})},getLabel:function(t){var t=t||this.get("rank")||"N";var e=__("page number");return e.replace("%d",t)},updatePartIndexNumber:function(t){var i=this.survey.pages();var r=this;var n=1;if(!t){for(var s=0,o;o=i[s++];){if(o===r)break;var a=0;e.each(o.parts(),function(t){t.isQuestion()&&a++});n+=a}}else{n=t}e.each(this.parts(),function(t){if(!t.isQuestion())return false;var e=t.el();if(e.is(":visible"))e.find(".index").text(n++ +".")})}},separator:{getTitle:function(){return this.get("title")||__("untitled separator")},getLabel:function(){return this.getTitle()}},html:{getCode:function(){return this.get("code")||__("custome content")},getLabel:function(){do{var e=this.get("code");if(!e)break;try{var i=t(e);var r=i.text();i.remove()}catch(n){return __("custome content")}if(!r)break;if(r.length<=20)return r;return r.substr(0,20)+" ..."}while(false);return __("custome content")}}};o.factory=function(t,r){var n,r;r=r||{};if(!r["__sn__"])r["__sn__"]=i();if(!r["__type__"])r["__type__"]=t;r["options"]&&e.each(r["options"],function(t){if(!t["__sn__"])t["__sn__"]=i()});n=o._defaults[t];if(n)r=e.extend(n(r),r);return new o(r)};function a(i){var r;var n=i.find('script[type="application/json"][name="parts"]')[0];var s=t.parseJSON(n.text);n.parentNode.removeChild(n);e.each(s,function(t){t=this.createPart(t["__type__"],t);if(t.is("survey")){r=t;this.isFresh=r.get("__fresh__")?function(){return true}:function(){return false};delete r.props["__fresh__"]}},this);if(r){e.extend(this,{set:e.bind(r.set,r),get:e.bind(r.get,r),has:e.bind(r.has,r),id:e.bind(r.id,r),is:e.bind(r.is,r),type:e.bind(r.type,r)})}this.$survey=i;this.setDirty(false)}a.prototype.createPart=function(t,e){var i=t instanceof o?t:o.factory(t,e);i.survey=this;this.setDirty(true);return n[i.id()]=i};a.prototype.removePart=function(t){delete n[t.id()];this.setDirty(true)};a.prototype.getTitle=function(){return this.get("title")||__("untitled survey")};a.prototype.parts=function(){return n};a.prototype.part=function(t){if(t instanceof o)return t;var e=n[t];if(!e)throw new Error("part not found, id: "+t);return e};a.prototype.findPartBy=function(e){var i;if(e instanceof t&&e.length)i=e.data("sn");return n[i]||false};a.prototype.pages=function(){var i=e.bind(function(e){return this.findPartBy(t(e))},this);var r="div.page[data-sn]";return e.map(this.$survey.find(r),i)};a.prototype.firstPage=function(){var t="div.page[data-sn]:first";var e=this.$survey.find(t);return this.findPartBy(e)};a.prototype.lastPage=function(){var t="div.page[data-sn]:last";var e=this.$survey.find(t);return this.findPartBy(e)};a.prototype.triggers=function(){if(this._triggers)return this._triggers;var e=t('script[type="application/json"][name=triggers]')[0];var i=e&&e.text?t.parseJSON(e.text):{};if(e)e.parentNode.removeChild(e);return this._triggers=new p(this,i)};a.prototype.size=function(){return e.chain(this.parts()).reduce(function(t,e){return t+e.size()},0).value()};a.prototype.normalize=function(){var t=this.get("__sn__");var i=this.isDirty();e.each(this.pages(),function(i,r){var n=i.id();i.set({rank:r+1,parent_sn:t});e.each(i.parts(),function(t,e){t.set({rank:e+1,parent_sn:n})})});if(!i)this.setDirty(false);this.triggers().sanitize()};a.prototype.setDirty=function(t){this._dirty=!!t};a.prototype.isDirty=function(){return this._dirty};function p(i,r){if(e.isEmpty(r)||!e.isObject(r))r={};this.survey=i;this.exprs=r;this._dfd=new t.Deferred;this._updated={}}p.prototype.setPartExpr=function(t,i,r){var n=this.survey;var o=this._prepareExpr(t,i);o=e.extend(o,{parts:r});s(o);this.eachExprs(function(t,i){if(!t["options"])return false;e.each(r,function(e){if(t["options"][e]){delete t["options"][e];this._notifyUpdate(i)}},this)},this);n.setDirty(true);this._notifyUpdate(t)};p.prototype.setOptionExpr=function(t,i,r,n){var o=this._prepareExpr(t,i);var a=e.keys(r);if(!o["options"]||!n){o["options"]=r}else{o["options"]=e.extend(o["options"],r)}this.eachExprs(function(t,i){if(!t["parts"])return false;var r=e.intersection(t["parts"],a);if(!r.length)return false;t["parts"]=e.difference(t["parts"],a);this._notifyUpdate(i)},this);s(o);this.survey.setDirty(true);this._notifyUpdate(t)};p.prototype.setFinishExpr=function(t,e,i){var r=this._prepareExpr(t,e);if(i){r["finish"]=1}else{delete r["finish"]}this.survey.setDirty(true)};p.prototype.getExprs=function(t,e){var i=this.exprs;if(!t)return i;if(t instanceof o)t=t.id();if(!i[t]||!e)return i[t];return i[t][e]};p.prototype.getCondition=function(t){var e=this._getIndex();if(t instanceof o)t=t.id();return e[t]};p.prototype.getPromise=function(){return this._dfd.promise()};p.prototype.removeExprs=function(t,e){var i=this.exprs;if(t instanceof o)t=t.id();if(!i[t])return true;if(e){delete i[t][e]}else{delete i[t]}this.survey.setDirty(true);this._notifyUpdate(t)};p.prototype.getHostParts=function(){var t=this.survey;s(this.exprs);return e.chain(this.exprs).keys().map(e.bind(t.part,t)).value()};p.prototype.removeExprByPart=function(t){var i=t.id();delete this.exprs[i];this.eachExprs(function(t){if(e.has(t,"parts")&&e.contains(t["parts"],i))t["parts"]=e.without(t["parts"],i);if(e.has(t,"options"))delete t["options"][i]});s(this.exprs)};p.prototype.eachExprs=function(t,e){var i,r;var n=this.exprs;e=e||null;for(i in n){for(r in n[i])t.apply(e,[n[i][r],i,r])}};p.prototype.updateOptionsInExprs=function(t){var i=[];var r=t.id();i=e.map(t.get("options"),function(e){return t.getOptionId(e)});this.eachExprs(function(t,n,s){if(n==r&&e.difference(s.split(","),i).length)delete t[s];if(!e.isEmpty(t["options"][r]))t["options"][r]=e.intersection(t["options"][r],i)});s(this.exprs)};p.prototype.sanitize=function(){this._sanitizeRemovedParts();this._sanitizeRemovedOptions();this._sanitizeByOrder();s(this.exprs)};p.prototype._sanitizeByOrder=function(){function t(t){if(!e.has(n,t)){var i=r.part(t);var s=i.is("page")?[i.get("rank")]:[i.parent().get("rank"),i.get("rank")];n[t]=s}return n[t]}function i(i,r){var n=t(i);var s=t(r);return e.any(n,function(t,e){return t<s[e]})}var r=this.survey;var n={};this.eachExprs(function(t,r,n){var s=this._getPartsInExpr(t);var o=e.filter(s,function(t){return!i(r,t)});if(o.length)this._removePartsInExpr(o,t)},this)};p.prototype._sanitizeRemovedParts=function(){var t=this.survey;var i=t.parts();this.eachExprs(function(t,r,n){if(!e.has(i,r))return this.removeExprs(r);if(e.has(t,"parts")){t["parts"]=e.filter(t["parts"],function(t){return e.has(i,t)})}if(e.has(t,"options")){e.each(t["options"],function(r,n){if(!e.has(i,n))delete t["options"][n]})}},this)};p.prototype._sanitizeRemovedOptions=function(){var t=this.survey;var i={};this.eachExprs(function(t,i,n){if(e.difference(n.split(","),r(i)).length)return this.removeExprs(i,n);if(e.has(t,"options"))e.each(t["options"],function(i,n){t["options"][n]=e.intersection(i,r(n))})},this);i=null;function r(r){if(!i[r]){var n=t.part(r);i[r]=e.map(n.get("options"),e.bind(n.getOptionId,n))}return i[r]}};p.prototype._prepareExpr=function(t,i){var r=this.exprs;if(t instanceof o)t=t.id();if(!e.has(r,t)){r[t]={};r[t][i]={}}else if(!e.has(r[t],i)){r[t][i]={}}return r[t][i]};p.prototype._getPartsInExpr=function(t){return e.chain(t).map(function(t,i){if(e.isArray(t))return t;if(e.isObject(t))return e.keys(t);return[]}).flatten().unique().value()};p.prototype._removePartsInExpr=function(t,i){e.each(i,function(r,n){if(e.isArray(r)){i[n]=e.difference(i[n],t)}else if(e.isObject(r)){e.each(r,function(i,n){if(e.contains(t,n))delete r[n]})}})};p.prototype._getIndex=function(){if(this._index)return this._index;var t={};this.eachExprs(function(i,r,n){e.each(this._getPartsInExpr(i),function(e){if(!t[e])t[e]={};if(!t[e][r])t[e][r]=[];t[e][r].push(n)});i.options&&e.each(i.options,function(i){e.each(i,function(e){if(!t[e])t[e]={};if(!t[e][r])t[e][r]=[];t[e][r].push(n)})})},this);return this._index=t};p.prototype._notifyUpdate=function(t){var i="triggers:notify:updated_host";if(t instanceof o)t=t.id();this._updated[t]=1;r.delay_till_last(i,e.bind(n,this),500);function n(){this._dfd.notify(e.keys(this._updated));this._updated={}}};exports.Survey=a;exports.Part=o});